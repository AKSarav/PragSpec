---
status: ready
---

# User Management

## Functional

### Why
Before users can manage tasks, they need a way to create an account and prove their
identity on subsequent requests. This feature provides the minimum viable auth surface:
register, login, and view your own profile.

### What

1. A new user registers with an email address and password.
2. The API validates the input, checks the email is not already taken, and creates the account.
3. The user logs in with their email and password and receives a JWT access token.
4. While authenticated, a user can fetch their own profile (id, email, created date).

**Acceptance criteria:**
- Registration with a valid, unique email and a password ≥ 8 characters returns 201 with user profile (no password field)
- Registration with an already-registered email returns 409 with code `EMAIL_ALREADY_EXISTS`
- Registration with an invalid email or password < 8 characters returns 400 with code `VALIDATION_ERROR`
- Login with correct credentials returns 200 with a JWT access token and expiry timestamp
- Login with an unregistered email returns 401 with code `INVALID_CREDENTIALS`
- Login with a wrong password returns 401 with code `INVALID_CREDENTIALS` (same code — no user enumeration)
- `GET /v1/users/me` with a valid token returns the authenticated user's profile
- `GET /v1/users/me` with no token or an expired token returns 401 with code `UNAUTHORIZED`

### Out of Scope
- Password reset / forgot password flow
- Email verification
- OAuth / social login
- Account deletion
- Admin user management (listing or modifying other users)
- Refresh tokens — clients re-authenticate on expiry

---

## Technical

### Data Model

**`users` table**

| Column | Type | Notes |
|---|---|---|
| `id` | UUID | Primary key, generated by DB |
| `email` | VARCHAR(255) | Unique, lowercase-normalised before storage |
| `passwordHash` | TEXT | bcrypt hash, cost factor 12 |
| `createdAt` | TIMESTAMPTZ | Set by DB on insert |

No `updatedAt` column — user records are not updated in v1.

### API Contract

---

#### `POST /v1/auth/register` — Register

**Request body (JSON):**
```json
{
  "email": "user@example.com",
  "password": "minimum8chars"
}
```

**Validations (Zod schema, in order):**
1. `email` — valid email format, required
2. `password` — string, minimum 8 characters, required
3. Email uniqueness checked against DB after schema validation

**Response 201:**
```json
{
  "id": "a1b2c3d4-...",
  "email": "user@example.com",
  "createdAt": "2026-02-20T10:00:00Z"
}
```

---

#### `POST /v1/auth/login` — Login

**Request body (JSON):**
```json
{
  "email": "user@example.com",
  "password": "minimum8chars"
}
```

**Response 200:**
```json
{
  "accessToken": "eyJ...",
  "expiresAt": "2026-02-20T11:00:00Z"
}
```

---

#### `GET /v1/users/me` — Get own profile

Requires `Authorization: Bearer <token>` header.

**Response 200:**
```json
{
  "id": "a1b2c3d4-...",
  "email": "user@example.com",
  "createdAt": "2026-02-20T10:00:00Z"
}
```

---

**Error codes used by this feature:**

| Code | Status | Trigger |
|---|---|---|
| `VALIDATION_ERROR` | 400 | Invalid email format or password too short |
| `EMAIL_ALREADY_EXISTS` | 409 | Email already registered |
| `INVALID_CREDENTIALS` | 401 | Wrong email or password (same code — no enumeration) |
| `UNAUTHORIZED` | 401 | Missing, malformed, or expired JWT |

### Implementation Notes

- Normalize email to lowercase before both insert and lookup — `user@Example.com` and `user@example.com` must be treated as the same address
- Never return a different error for "email not found" vs "wrong password" — both return `INVALID_CREDENTIALS` with status 401
- The `passwordHash` column must never appear in any response object or log output; use a Prisma `select` that explicitly omits it
- JWT payload must contain `{ sub: user.id, email: user.email }` — nothing more
- JWT secret is read from `process.env.JWT_SECRET`; throw a startup error if unset

---

## Open Questions
_(none)_
